"use strict";(self.webpackChunkproduct_docs=self.webpackChunkproduct_docs||[]).push([[2668],{5486:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>a,contentTitle:()=>s,default:()=>h,frontMatter:()=>r,metadata:()=>l,toc:()=>c});var i=t(5893),o=t(1151);const r={description:"Integration Guide for OpenVPN on Linux",last_update:{date:"01-11-2024"},slug:"/how-tos/openvpn-integration-linux"},s="OpenVPN Integration Guide for Linux",l={id:"how-tos/openvpn/integration-linux",title:"OpenVPN Integration Guide for Linux",description:"Integration Guide for OpenVPN on Linux",source:"@site/docs/how-tos/openvpn/integration-linux.md",sourceDirName:"how-tos/openvpn",slug:"/how-tos/openvpn-integration-linux",permalink:"/pr-preview/pr-238/how-tos/openvpn-integration-linux",draft:!1,unlisted:!1,editUrl:"https://github.com/emnify/product-docs/blob/main/docs/how-tos/openvpn/integration-linux.md",tags:[],version:"current",lastUpdatedAt:1704931200,formattedLastUpdatedAt:"Jan 11, 2024",frontMatter:{description:"Integration Guide for OpenVPN on Linux",last_update:{date:"01-11-2024"},slug:"/how-tos/openvpn-integration-linux"}},a={},c=[{value:"Add mandatory layer of security and privacy",id:"add-mandatory-layer-of-security-and-privacy",level:2},{value:"Setting Up OpenVPN Client on Linux/Ubuntu",id:"setting-up-openvpn-client-on-linuxubuntu",level:2},{value:"Install OpenVPN Software",id:"install-openvpn-software",level:3},{value:"Create Credentials for Authentication",id:"create-credentials-for-authentication",level:3},{value:"Protecting the Credentials File",id:"protecting-the-credentials-file",level:3},{value:"Starting and Monitoring the OpenVPN connection",id:"starting-and-monitoring-the-openvpn-connection",level:3},{value:"Finding the static private IP of your VPN client",id:"finding-the-static-private-ip-of-your-vpn-client",level:3},{value:"Testing Successfull Data Connectivity",id:"testing-successfull-data-connectivity",level:3},{value:"Enabling Access for Servers behind the VPN client",id:"enabling-access-for-servers-behind-the-vpn-client",level:3}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.a)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.h1,{id:"openvpn-integration-guide-for-linux",children:"OpenVPN Integration Guide for Linux"}),"\n",(0,i.jsx)(n.p,{children:"emnify customers can create their own Virtual Private Network for their mobile IoT/M2M devices fitted with emnify SIMs.\nData traffic will be exchanged between the devices and the application server through an OpenVPN tunnel, enabling direct communication with the IPs of the mobile devices (no NAT applied)."}),"\n",(0,i.jsx)(n.p,{children:"The tunnel is established between the emnify Core Network and the customers VPN gateway or server."}),"\n",(0,i.jsxs)(n.p,{children:["See this video ",(0,i.jsx)(n.a,{href:"https://www.youtube.com/watch?v=yt44fJpfkQ4",children:"guide for how to secure your devices with Open VPN"}),"."]}),"\n",(0,i.jsx)(n.h2,{id:"add-mandatory-layer-of-security-and-privacy",children:"Add mandatory layer of security and privacy"}),"\n",(0,i.jsxs)(n.p,{children:["Any traffic exchanged with the mobile devices is encrypted before transmitted over the public internet, therefore adding an additional layer of security and privacy.\nFor that ",(0,i.jsx)(n.strong,{children:"no"})," VPN software needs to be installed on the device or any configuration changes to be done, the default emnify APN does also support VPN flows."]}),"\n",(0,i.jsx)(n.p,{children:"First, download the VPN config file from the emnify User Interface"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:'Click on the "Integrations" menu'}),"\n",(0,i.jsx)(n.li,{children:'Scroll down to the "secure connection" section and download the configuration file'}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"Additionally, you need to change the Internet Regional Breakout in the device policy:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:'Click on "Device Policies"'}),"\n",(0,i.jsx)(n.li,{children:'Scroll down to "Service Policies", select the policy assigned to the devices you want to secure and click on "Details".'}),"\n",(0,i.jsxs)(n.li,{children:['On the "Internet Breakout Region" menu, set the Service Policy to a VPN breakout region, e.g., ',(0,i.jsx)(n.code,{children:"eu-west-1 (VPN)"})]}),"\n"]}),"\n",(0,i.jsx)(n.h2,{id:"setting-up-openvpn-client-on-linuxubuntu",children:"Setting Up OpenVPN Client on Linux/Ubuntu"}),"\n",(0,i.jsx)(n.h3,{id:"install-openvpn-software",children:"Install OpenVPN Software"}),"\n",(0,i.jsx)(n.p,{children:"Install openvpn package"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.code,{children:"sudo apt-get install openvpn"})}),"\n",(0,i.jsxs)(n.p,{children:['Log in with your user account on the emnify Portal and select the "Link" Icon on the top/right.\nFrom there you can download a pre-configured configuration file, the filename is ',(0,i.jsx)(n.strong,{children:"client.conf"})]}),"\n",(0,i.jsx)(n.p,{children:"Download and Install VPN Configuration File"}),"\n",(0,i.jsx)(n.p,{children:"Please store that file on your server in the folder /etc/openvpn."}),"\n",(0,i.jsx)(n.h3,{id:"create-credentials-for-authentication",children:"Create Credentials for Authentication"}),"\n",(0,i.jsxs)(n.p,{children:["In the next steps you need to create a file called ",(0,i.jsx)(n.strong,{children:"credentials.txt"})," in the folder /etc/openvpn. You can choose to use your user credentials to authenticate or to use an application token (recommended)."]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Authentication with User Credentials\nThe content of the credentials.txt must be just two lines, first line your username and second your password."}),"\n"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"username@domain.com\nYourPassword\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:'Authentication with Application Token\nIf you do not want to store your credentials you can also choose to enter them each time the VPN tunnel is established, if you prefer that option please comment out the line "auth-user-pass /etc/openvpn/credentials.txt" in the client.conf file.'}),"\n"]}),"\n",(0,i.jsx)(n.p,{children:"When you run the OpenVPN client on a VPN gateway or application server it is recommended to use a dedicated application token.\nIn this case the first line in the credentials.txt file needs to be filled with your emnify organisation identifier and instead of the password you store the application token."}),"\n",(0,i.jsx)(n.p,{children:'You can create application tokens when you log in to the emnify Portal, select the "Link" Icon on the top/right and then "Create New Application Token".\nPlease Copy+Paste the token into the credentials file.'}),"\n",(0,i.jsx)(n.p,{children:"The content of the credentials file would then look like this"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"orgId\nApplicationToken\n"})}),"\n",(0,i.jsx)(n.p,{children:"When you log in to the emnify Portal it will shows this data under the VPN settings."}),"\n",(0,i.jsx)(n.h3,{id:"protecting-the-credentials-file",children:"Protecting the Credentials File"}),"\n",(0,i.jsx)(n.p,{children:"You should keep the credentials.txt file only readable by root and not by other users of your server.\nYou can ensure this with the following commands:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"sudo chown root:root /etc/openvpn/credentials.txt\nsudo chmod 600 /etc/openvpn/credentials.txt\n"})}),"\n",(0,i.jsx)(n.h3,{id:"starting-and-monitoring-the-openvpn-connection",children:"Starting and Monitoring the OpenVPN connection"}),"\n",(0,i.jsx)(n.p,{children:"Now you can start the VPN client by running"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"sudo service openvpn start\n"})}),"\n",(0,i.jsx)(n.p,{children:"The openvpn daemon will log into /var/log/syslog, if everything works it would like this:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Jul 12 17:53:55 openvpn-client ovpn-client[3027]: Data Channel Encrypt: Cipher 'BF-CBC' initialized with 128 bit key\nJul 12 17:53:55 openvpn-client ovpn-client[3027]: Data Channel Encrypt: Using 160 bit message hash 'SHA1' for HMAC authentication\nJul 12 17:53:55 openvpn-client ovpn-client[3027]: Control Channel: TLSv1, cipher TLSv1/SSLv3 DHE-RSA-AES256-SHA, 2048 bit RSA\nJul 12 17:53:55 openvpn-client ovpn-client[3027]: [openvpn.emnify.net] Peer Connection Initiated with [AF_INET]52.209.x.y:1194\nJul 12 17:53:57 openvpn-client ovpn-client[3027]: SENT CONTROL [openvpn.emnify.net]: 'PUSH_REQUEST' (status=1)\nJul 12 17:53:57 openvpn-client ovpn-client[3027]: PUSH: Received control message: 'PUSH_REPLY,route 10.64.0.1,topology net30,ping 1,ping-restart 5,route 10.x.y.z 255.255.128.0,ifconfig 10.64.0.224 10.64.0.225'\nJul 12 17:53:57 openvpn-client ovpn-client[3027]: TUN/TAP device tun0 opened\nJul 12 17:53:57 openvpn-client ovpn-client[3027]: /sbin/route add -net 10.64.0.1 netmask 255.255.255.255 gw 10.64.0.225\nJul 12 17:53:57 openvpn-client ovpn-client[3027]: /sbin/route add -net 10.x.y.z netmask 255.255.128.0 gw 10.64.0.225\n"})}),"\n",(0,i.jsx)(n.h3,{id:"finding-the-static-private-ip-of-your-vpn-client",children:"Finding the static private IP of your VPN client"}),"\n",(0,i.jsx)(n.p,{children:"The emnify OpenVPN server will allocate a static IP address to the tun interface of your VPN client, this IP will also stay the same when your VPN client is reconnecting or if you move the tunnel to a different machine.\nSo you can use it on your mobile devices to address your application, nevertheless you should never configure the IP directly on your devices, but use a DNS to resolve it."}),"\n",(0,i.jsx)(n.p,{children:"Once the tunnel is establish you can see that IP address on your tun interface:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"ubuntu@openvpn-client:~$ ip a s tun0\n14: tun0: <POINTOPOINT,MULTICAST,NOARP,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN qlen 100\n    link/none \n    inet 10.64.0.224 peer 10.64.0.225/32 scope global tun0\n"})}),"\n",(0,i.jsx)(n.p,{children:"In this sample the IP address is 10.64.0.224"}),"\n",(0,i.jsx)(n.h3,{id:"testing-successfull-data-connectivity",children:"Testing Successfull Data Connectivity"}),"\n",(0,i.jsx)(n.p,{children:"If the VPN tunnel is established successfully you will be able to connect directly to the private IP addresses of your mobile devices."}),"\n",(0,i.jsx)(n.p,{children:"For testing you can choose any for your endpoints that as currently an active data session, for log in to the emnify Portal and select on of your endpoints, in the details you will if it is currently online or not and you will see the IP address it has assigned."}),"\n",(0,i.jsx)(n.p,{children:"Now will be able to ping that private IP address:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"root@openvpn-client:~# ping 10.x.y.z\nPING 10.x.y.z (10.x.y.z) 56(84) bytes of data.\n64 bytes from 10.x.y.z: icmp_req=1 ttl=62 time=72 ms\n64 bytes from 10.x.y.z: icmp_req=2 ttl=62 time=80 ms\n64 bytes from 10.x.y.z: icmp_req=3 ttl=62 time=75 ms\n"})}),"\n",(0,i.jsx)(n.p,{children:"For this to work your device needs to run an IP stack that is responding to ICMP echo request, this might not be the case for embedded devices that do implement only partial IP stack functionality."}),"\n",(0,i.jsx)(n.p,{children:"You will be able to use any network protocolls, e.g. if your device is running a sshd daemon you would now be able to log into it via ssh."}),"\n",(0,i.jsx)(n.h3,{id:"enabling-access-for-servers-behind-the-vpn-client",children:"Enabling Access for Servers behind the VPN client"}),"\n",(0,i.jsx)(n.p,{children:"If you have multiple servers behind your VPN gateway that need to communicate with your mobile device, you can apply masquerading using iptables to hide them behind the single IP address of your VPN client."}),"\n",(0,i.jsx)(n.p,{children:"First you need to enable IP forwarding on your VPN gateway (if not already active) by editing your /etc/sysctl.conf and set net.ipv4.ip_forward=1, after that load the config with sudo sysctl -p /etc/sysctl.conf"}),"\n",(0,i.jsx)(n.p,{children:"After that you need to enable masquerading for the tun interface by running"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"sudo iptables -t nat -A POSTROUTING -o tun0 -j MASQUERADE\n"})}),"\n",(0,i.jsx)(n.p,{children:"You can also forward connections coming to specific ports to an application server behind your VPN gateway by using DNAT, e.g. to forward to an internal HTTP server at IP 192.168.100.21 use:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"sudo iptables -t nat -A PREROUTING -i tun0 -p tcp --dport 80 -j DNAT --to-destination 192.168.100.21\n"})}),"\n",(0,i.jsx)(n.p,{children:"If you want to make these settings persistent you can use the iptables-persistent package."})]})}function h(e={}){const{wrapper:n}={...(0,o.a)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},1151:(e,n,t)=>{t.d(n,{Z:()=>l,a:()=>s});var i=t(7294);const o={},r=i.createContext(o);function s(e){const n=i.useContext(r);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),i.createElement(r.Provider,{value:n},e.children)}}}]);